<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç¾å°‘å¥³è¨˜å¸³æœ¬</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bright-pink: #daa4a4; 
            --hover-pink: #daa4a4;
            --text-gray: #444;
        }
        body { 
            background-color: #FFFFFF; 
            font-family: "Microsoft JhengHei", sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 30px; /* ç¶­æŒå››å‘¨é–“è· */
            color: var(--text-gray); 
        }

        /* å¤§æ¨™é¡Œï¼šä¸Šä¸‹å„ç©ºå‡ºä¸€è¡Œçš„ç©ºé–“ */
        h1 { 
            color: var(--bright-pink); 
            font-size: 2.2rem; 
            margin-top: 40px;    /* æ¨™é¡Œä¸Šæ–¹ç©ºä¸€è¡Œ */
            margin-bottom: 40px; /* æ¨™é¡Œä¸‹æ–¹ç©ºä¸€è¡Œ */
        }
        
        .info-bar {
            width: 100%;
            max-width: 550px;
            text-align: center;
            margin-bottom: 15px;
            color: var(--bright-pink);
            font-weight: bold;
        }
        .info-total { font-size: 1.2rem; display: block; }

        .card { 
            background: white; 
            padding: 25px; 
            border: 1px solid #f0f0f0;
            border-radius: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            width: 100%; 
            max-width: 550px; 
            text-align: center; 
        }

        .input-row { margin-bottom: 10px; }
        .full-width { width: 90% !important; max-width: 300px; }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }

        input, select { 
            padding: 12px; 
            border: 2px solid var(--bright-pink); 
            border-radius: 10px; 
            margin: 5px; 
            width: 140px; 
            outline: none; 
            font-size: 1rem;
        }

        button { 
            background-color: var(--bright-pink); 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: 0.3s; 
            margin: 5px;
            font-size: 1.1rem; 
        }
        button:hover { background-color: var(--hover-pink); }

        .category-manage { margin-top: 15px; }
        .total-info { font-size: 1.4rem; color: var(--hover-pink); font-weight: bold; margin: 20px 0; }
        #chartBox { display: none; margin-top: 10px; }
        
        .backup-section {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
        }
        .backup-btn { background-color: #aaa; font-size: 0.9rem; padding: 8px 15px; }
        .backup-text { font-size: 1rem; color: #bbb; margin-bottom: 10px; }

        .photo-section {
            margin-top: 20px;
            padding: 15px;
            border: 2px dashed #eee;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        #previewImg {
            max-width: 100%;
            border-radius: 15px;
            margin-top: 10px;
            display: none;
        }
        .upload-btn { background-color: #eee; color: #888; font-size: 0.8rem; padding: 5px 10px; }
    </style>
</head>
<body>

    <h1>ç¾å°‘å¥³è¨˜å¸³æœ¬ğŸ‘¸ğŸ»</h1>

    <div class="info-bar">
        <span id="monthTotalLabel" class="info-total">ç•¶æœˆç¸½è¨ˆ: $0</span>
    </div>

    <div class="card">
        <div class="input-row">
            <input type="date" id="recordDate" class="full-width">
        </div>
        <div class="input-row">
            <input type="number" id="amount" placeholder="è¼¸å…¥é‡‘é¡" step="any">
            <select id="categorySelect"></select>
            <button onclick="addRecord()">æ–°å¢ç´€éŒ„</button>
        </div>

        <div class="category-manage">
            <input type="text" id="newCategoryName" placeholder="æ–°é¡åˆ¥åç¨±" style="width: 100px; padding: 8px; font-size: 0.8rem;">
            <button onclick="addCategory()" style="padding: 8px 15px; font-size: 0.9rem;">æ–°å¢é¡åˆ¥</button>
            <button onclick="deleteCategory()" style="background: #daa4a4; padding: 8px 15px; font-size: 0.9rem;">åˆªé™¤é¡åˆ¥</button>
        </div>

        <hr style="border:0; border-top: 1px solid #eee; margin: 15px 0;">

        <button onclick="showStats('month')">ç•¶æœˆç¸½è¨ˆ</button>
        <button onclick="showStats('year')">ä»Šå¹´ç¸½è¨ˆ</button>

        <div id="chartBox">
            <div id="summaryLabel" class="total-info"></div>
            <canvas id="myChart"></canvas>
        </div>

        <div class="backup-section">
            <p class="backup-text">ğŸ”’è¨˜å¾—å‚™ä»½</p>
            <button class="backup-btn" onclick="exportData()">ä¸‹è¼‰ç´€éŒ„å‚™ä»½</button>
            <button class="backup-btn" onclick="document.getElementById('fileInput').click()">åŒ¯å…¥å‚™ä»½æª”æ¡ˆ</button>
            <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
        </div>
    </div>

    <div class="photo-section">
        <span style="color:#aaa; font-size: 0.9rem;">âœ¨</span><br>
        <button class="upload-btn" onclick="document.getElementById('photoInput').click()">é»æ“Šæ–°å¢/æ›´æ›ç…§ç‰‡</button>
        <input type="file" id="photoInput" style="display:none" accept="image/*" onchange="uploadPhoto(event)">
        <img id="previewImg" src="" alt="ç…§ç‰‡é è¦½">
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('girl_records_v3')) || [];
        let categories = JSON.parse(localStorage.getItem('girl_cats_v3')) || ["åƒé£¯", "è¡£æœ", "äº¤é€š"];
        let myChart = null;

        function initHeader() {
            const now = new Date();
            document.getElementById('recordDate').valueAsDate = now;

            const monthTotal = records.reduce((sum, r) => {
                const rDate = new Date(r.date);
                if(rDate.getMonth() === now.getMonth() && rDate.getFullYear() === now.getFullYear()) return sum + r.amt;
                return sum;
            }, 0);
            document.getElementById('monthTotalLabel').innerText = `ç•¶æœˆç¸½è¨ˆ: $${monthTotal}`;

            const savedImg = localStorage.getItem('girl_photo');
            if (savedImg) {
                const img = document.getElementById('previewImg');
                img.src = savedImg;
                img.style.display = 'inline-block';
            }
        }

        function uploadPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgData = e.target.result;
                localStorage.setItem('girl_photo', imgData);
                const img = document.getElementById('previewImg');
                img.src = imgData;
                img.style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        }

        function updateCategoryDropdown() {
            const select = document.getElementById('categorySelect');
            select.innerHTML = '';
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.innerText = cat;
                select.appendChild(opt);
            });
        }

        function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if(!name) return;
            if(categories.includes(name)) return alert("é€™é¡åˆ¥å·²ç¶“æœ‰äº†å–”ï¼");
            categories.push(name);
            localStorage.setItem('girl_cats_v3', JSON.stringify(categories));
            document.getElementById('newCategoryName').value = '';
            updateCategoryDropdown();
        }

        function deleteCategory() {
            const select = document.getElementById('categorySelect');
            const selectedCat = select.value;
            if(!selectedCat) return;
            if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${selectedCat}ã€é¡åˆ¥å—ï¼Ÿ`)) {
                categories = categories.filter(c => c !== selectedCat);
                localStorage.setItem('girl_cats_v3', JSON.stringify(categories));
                updateCategoryDropdown();
            }
        }

        function addRecord() {
            const amt = document.getElementById('amount').value;
            const cat = document.getElementById('categorySelect').value;
            const date = document.getElementById('recordDate').value;
            if(!amt || !cat || !date) return alert("è«‹å¡«å…¥è³‡æ–™ï¼");

            records.push({ amt: parseFloat(amt), cat: cat, date: new Date(date).toISOString() });
            localStorage.setItem('girl_records_v3', JSON.stringify(records));
            document.getElementById('amount').value = '';
            alert("è¨˜å¥½å›‰ï¼âœ¨");
            initHeader();
        }

        function showStats(type) {
            document.getElementById('chartBox').style.display = 'block';
            const now = new Date();
            const filtered = records.filter(r => {
                const d = new Date(r.date);
                return type === 'month' ? (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) : (d.getFullYear() === now.getFullYear());
            });
            let total = 0;
            const stats = {};
            filtered.forEach(r => {
                total += r.amt;
                stats[r.cat] = (stats[r.cat] || 0) + r.amt;
            });
            document.getElementById('summaryLabel').innerText = (type === 'month' ? "æœ¬æœˆ" : "ä»Šå¹´") + "æ”¯å‡ºï¼š$" + total;
            if(myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('myChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(stats),
                    datasets: [{ data: Object.values(stats), backgroundColor: ['#FFB7C5', '#FFD1DC', '#FFC0CB', '#FF9EAF', '#FF85A2'] }]
                }
            });
        }

        function exportData() {
            if(records.length === 0) return alert("æ²’æœ‰ç´€éŒ„å–”ï¼");
            const data = { records, categories };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å‚™ä»½_${new Date().toLocaleDateString()}.json`;
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const imported = JSON.parse(evt.target.result);
                records = imported.records || [];
                categories = imported.categories || [];
                localStorage.setItem('girl_records_v3', JSON.stringify(records));
                localStorage.setItem('girl_cats_v3', JSON.stringify(categories));
                alert("åŒ¯å…¥æˆåŠŸï¼ğŸ’–");
                location.reload();
            };
            reader.readAsText(file);
        }

        updateCategoryDropdown();
        initHeader();
    </script>
</body>
</html>